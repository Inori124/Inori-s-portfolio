{"title":"银行电话营销转化预测","markdown":{"yaml":{"title":"银行电话营销转化预测","author":"曹颖","date":"2026-01-30","categories":["Machine Learning","R","Visualization"],"image":"image.jpg"},"headingText":"1. 项目背景","containsRefs":false,"markdown":"\n\n在这个项目中，我分析了葡萄牙银行机构的电话营销数据...\n\n## 2. 数据探索 (EDA)\n我使用 R 语言的 ggplot2 绘制了云雨图来观察通话时长分布：\n\n# 导入必要的包\n\n```{r}\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(scales)\n```\n\n# 导入数据\n\n```{r}\ndf <- read_delim(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/bank+marketing/bank-additional/bank-additional-full.csv\", delim = \";\", show_col_types = FALSE)\nhead(df)\n```\n\n# 绘制变量分布图\n## 绘制离散型变量分布图（堆叠条形图）\n\n```{r}\nplot_data <- df %>% \n  select(where(is.character)) %>%\n  pivot_longer(cols = everything(), names_to = \"variable\", values_to = \"category\") %>%\n  group_by(variable, category) %>%\n  summarise(count = n(), .groups = \"drop_last\") %>%\n  mutate(\n    prop = count / sum(count),\n    label_text = ifelse(prop > 0.15, category, \"\") # 只显示占比大于15%的标签\n  ) %>%\n  \n  arrange(variable, desc(prop)) %>% # 按占比降序排列\n  mutate(rank = as.factor(row_number())) %>% \n  ungroup()\n\n# 绘图\nmy_blue_palette <- colorRampPalette(RColorBrewer::brewer.pal(9, \"Blues\")) # 设置调色盘\n\nggplot(plot_data, aes(x = prop, y = variable, fill = rank)) +\n  geom_col(width = 0.7, color = \"white\", alpha = 0.95) +\n  \n  geom_text(aes(label = label_text), \n            position = position_stack(vjust = 0.5), \n            size = 5, color = \"white\", fontface = \"bold\") +\n  \n  scale_fill_manual(values = rev(my_blue_palette(length(unique(plot_data$rank))))) +\n  \n  scale_x_continuous(labels = percent, expand = c(0,0)) +\n  labs(title = NULL, \n       x = NULL, y = NULL) +\n  theme_minimal() +\n  theme(\n    legend.position = \"none\",\n    panel.grid = element_blank(),\n    axis.text.y = element_text(size = 11, face = \"bold\", color = \"#2C3E50\"),\n    axis.text.x = element_text(color = \"grey60\")\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/discrete.png\", width = 12, height = 8, dpi = 300)\n```\n\n## 绘制连续型变量分布图\n\n```{r}\nplot_data_cont_stacked <- df %>%\n  select(where(is.numeric), y) %>%   \n  pivot_longer(cols = -y,            \n               names_to = \"variable\", \n               values_to = \"value\")\n\nggplot(plot_data_cont_stacked, aes(x = value, fill = y)) +\n  geom_histogram(bins = 30,            \n                 alpha = 1,          \n                 position = \"stack\") + \n  scale_fill_manual(values = c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\"), \n                    name = \"y\") +\n  facet_wrap(~ variable, scales = \"free\", ncol = 5) +\n  labs(title = NULL, \n       subtitle = NULL,\n       x = NULL, \n       y = NULL) +\n  theme_minimal() + \n  theme(\n    plot.title = element_text(face = \"bold\", size = 14, color = \"#2C3E50\"),\n    legend.position = \"bottom\",                      \n    strip.background = element_rect(fill = \"#EBF5FB\", color = NA), \n    strip.text = element_text(color = \"#143A72\", face = \"bold\"),   \n    panel.grid = element_blank(),\n    panel.border = element_rect(color = \"black\", fill = NA, linewidth = 0.5) \n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/continuous.png\", width = 12, height = 5, dpi = 300)\n```\n\n# 初步数据清洗\n\n```{r}\n# 1. 检查缺失值/数据去重\n  missing_values <- colSums(is.na(df)) # 检查每一列的缺失值数量\n  print(missing_values)\n  \n  duplicate_rows <- sum(duplicated(df)) # 检查是否存在重复行\n  print(paste(\"重复行数量:\", duplicate_rows))\n  \n  df_clean <- df %>% distinct() # 如果有重复行，删除\n\n# 2. 数据转义\ndf_trans <- df_clean %>%\n  mutate(\n    across(where(is.character), \\(x) na_if(x, \"unknown\")), # 将所有字符型变量中的 \"unknown\" 替换为 NA\n    pdays = na_if(pdays, 999) # \"pdays\" 中的 \"999\" 替换为 NA\n  )\n\n# 检查结果\ndf_trans %>%\n  select(job, default, housing, loan, pdays, marital, education) %>%\n  head(10)\n```\n\n# 探索性数据分析\n\n```{r}\n# 加载必要的包\nlibrary(patchwork)\nlibrary(tidyverse)\nlibrary(scales)\nlibrary(ggridges)\nlibrary(gghalves)\n```\n\n## 个人信息类\n\n```{r}\ntarget_variables <- c(\"job\", \"education\", \"marital\", \"default\", \"housing\", \"loan\")\n\nfor (var in target_variables) {\n  \n  # 预处理数据并计算占比，用于排序\n  rank_data <- df_trans %>%\n    filter(!is.na(!!sym(var))) %>%\n    count(!!sym(var)) %>%\n    arrange(n) # 从小到大排序\n  \n  # 准备绘图数据\n  plot_data <- df_trans %>%\n    select(y, !!sym(var)) %>%\n    mutate(!!sym(var) := fct_na_value_to_level(factor(!!sym(var)), level = \"NA\")) %>%\n    mutate(!!sym(var) := fct_reorder(!!sym(var), .x = (!!sym(var) == \"NA\"), .desc = FALSE)) \n    \n  non_na_levels <- rank_data[[var]]\n  plot_data <- plot_data %>%\n    mutate(!!sym(var) := fct_relevel(!!sym(var), \"NA\", after = 0)) %>%\n    mutate(!!sym(var) := fct_relevel(!!sym(var), as.character(non_na_levels), after = 1))\n\n  # 构造颜色向量\n  levels_present <- levels(plot_data[[var]])\n  num_non_na <- sum(levels_present != \"NA\")\n  custom_colors <- c(\"#D3D3D3\", my_blue_palette(num_non_na)) \n  names(custom_colors) <- levels_present\n\n  # 绘图\n  p <- ggplot(plot_data, aes(x = y, fill = !!sym(var))) +\n    geom_bar(position = \"fill\", color = \"black\", linewidth = 0.2) + \n    geom_text(\n      aes(label = !!sym(var)),\n      stat = \"count\", \n      position = position_fill(vjust = 0.5),\n      size = 3,\n      color = \"black\",\n      fontface = \"bold\",\n      check_overlap = TRUE\n    ) +\n    scale_fill_manual(values = custom_colors) +\n    scale_y_continuous(labels = scales::percent) +\n    theme_minimal() +\n    labs(title = NULL,\n         x = \"y\",\n         y = paste(\"% of\", var),\n         fill = var)\n  print(p)\n  \n  file_name <- paste0(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/plot_\", var, \".png\")\n  ggsave(filename = file_name, plot = p, width = 8, height = 6, dpi = 300)\n}\n```\n\n### Default 变量的缺失视作一类，并重新分为没有违约记录和其他\n\n```{r}\npng(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/Default_Mosaic_Comparison.png\", width = 2000, height = 1000, res = 200)\n\npar(mfrow = c(1, 2))\n\ncounts_before <- table(df_trans$default, df_trans$y, useNA = \"ifany\")\nrownames(counts_before)[is.na(rownames(counts_before))] <- \"NA\"\n\n# plot1\nmosaicplot(counts_before,\n           main = \"Before Reclassify\",\n           xlab = \"default\", \n           ylab = \"y\",\n           color = c(\"#C6DBEF\", \"#1D3567\"), \n           border = \"black\",\n           las = 1)\n\n# 合并default变量\ndf_trans <- df_trans %>%\n  mutate(\n    default = default %>%\n      fct_na_value_to_level(level = \"other\") %>%\n      fct_collapse(other = \"yes\")\n  )\n\ncounts_trans <- table(df_trans$default, df_trans$y, useNA = \"ifany\")\n\n# plot2\nmosaicplot(counts_trans,\n           main = \"After Reclassify\",\n           xlab = \"default\", \n           ylab = \"y\",\n           color = c(\"#C6DBEF\", \"#1D3567\"), \n           border = \"black\",\n           las = 1)\ndev.off()\n\npar(mfrow = c(1, 1))\n```\n\n### education变量类型转换\n\n```{r}\n# 1. 绘制education和job变量热力图\nheatmap_absolute <- df_trans %>%\n  select(job, education) %>%\n  mutate(across(c(job, education), ~fct_na_value_to_level(factor(.), level = \"NA\"))) %>%\n  count(job, education) %>%\n  ungroup() %>%\n  mutate(prop = n / sum(n))\n\nggplot(heatmap_absolute, aes(x = education, y = job, fill = prop)) +\n  geom_tile(color = \"white\", lwd = 0.5) +\n  \n  geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),\n            color = ifelse(heatmap_absolute$prop > max(heatmap_absolute$prop) / 2, \"white\", \"black\"),\n            size = 3) +\n  \n  scale_fill_distiller(palette = \"Blues\",\n                       direction = 1,\n                       labels = scales::percent,\n                       name = \"Percentage\") +\n  theme_minimal() +\n  labs(title = \"\",\n       x = \"education\",\n       y = \"job\") +\n  theme(\n    panel.grid = element_blank(), # 去掉所有网格线\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    legend.position = \"none\"\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/heatmap.png\", width = 12, height = 10, dpi = 300)\n\n# 2. education变量转换\ndf_edu_trans <- df_trans %>%\n  mutate(education = case_match(education,\n     \"illiterate\" ~ 1,\n     \"basic.4y\" ~ 4,\n     \"basic.6y\" ~ 6,\n     \"basic.9y\" ~ 9,\n     \"high.school\" ~ 12,\n     \"professional.course\" ~ 14,\n     \"university.degree\" ~ 16,\n     .default = NA \n  ))\n\n# 3. 绘制山峦图\ndf_plot_ridges <- df_edu_trans %>%\n  filter(!is.na(job), !is.na(education)) %>%\n  mutate(job = fct_reorder(job, education, .fun = median))\n\nggplot(df_plot_ridges, aes(x = education, y = job, fill = after_stat(x))) + \n  geom_density_ridges_gradient(scale = 1.5, rel_min_height = 0.01) +\n  \n  scale_fill_distiller(palette = \"Blues\",\n                       direction = 1,\n                       name = \"Years\") +\n  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)) + \n  theme_ridges(font_size = 12, grid = FALSE) +\n  labs(title = \"\",\n       x = \"Years of Education\",\n       y = \"Job\") +\n  theme(\n    axis.title.x = element_text(hjust = 0.5, size = 14),\n    axis.title.y = element_text(hjust = 0.5, size = 14),\n    legend.position = \"none\"\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/peak_plot.png\", width = 12, height = 8, dpi = 300)\n```\n\n### marital变量重新划分\n\n```{r}\n# 1. 生成交叉表（包含 NA）\ncounts_marital <- table(df_edu_trans$marital, df_edu_trans$y, useNA = \"ifany\")\n\n# 2. 把 <NA> 行名改成字符串 \"NA\"\nrownames(counts_marital)[is.na(rownames(counts_marital))] <- \"NA\"\n\n# 3. 绘图\nmosaicplot(counts_marital,\n           main = \"\",\n           xlab = \"y\", \n           ylab = \"Marital Status\",  \n           color = c(\"#C6DBEF\", \"#1D3567\"), \n           border = \"black\",  # 白色分割线，现代感强\n           lwd = 1,           # 边框粗细\n           las = 1            # 纵轴标签水平显示\n)\n\n# 4. marital变量划分为：结过婚(married & divorced, 1) vs 没结过婚(single, 0)\ndf_marital_trans <- df_edu_trans %>%\n  mutate(\n    marital = fct_collapse(\n      marital,\n      \"1\" = c(\"married\", \"divorced\"),\n      \"0\" = \"single\"\n    )\n  )\nhead(df_marital_trans)\n```\n\n### 保留age变量数值类型不做分箱（云雨图）\n\n```{r}\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\nnudge_gap <- 0.2\n\nplot_split_violin <- function(data, x_var, y_var, group_var, x_label) {\n  \n  ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]], fill = .data[[group_var]])) +\n    \n    geom_half_violin(\n      data = data %>% filter(.data[[group_var]] == \"yes\"),\n      aes(fill = .data[[group_var]]),\n      side = \"r\",   \n      position = position_nudge(x = nudge_gap),\n      scale = \"width\", alpha = 0.9, color = \"black\", lwd = 0.5\n    ) +\n    \n    geom_half_violin(\n      data = data %>% filter(.data[[group_var]] == \"no\"),\n      aes(fill = .data[[group_var]]),\n      side = \"r\",\n      position = position_nudge(x = nudge_gap),\n      scale = \"width\", alpha = 0.9, color = \"black\", lwd = 0.5\n    ) +\n    \n    geom_point(\n    aes(color = .data[[group_var]]), \n    position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0), \n    size = 0.3, alpha = 0.2, shape = 21, color = \"white\", show.legend = FALSE\n    ) +\n    \n    geom_boxplot(\n      width = 0.15,  \n      position = position_dodge(width = 0.2),\n      outlier.shape = NA, \n      alpha = 1, color = \"black\", lwd = 0.3, show.legend = TRUE\n    ) +\n    \n    stat_summary(\n      fun = mean, geom = \"point\", shape = 23, size = 1.5, fill = \"white\",\n      position = position_dodge(width = 0.15), show.legend = FALSE\n    ) +\n\n    scale_fill_manual(values = my_colors) +\n    theme_classic() +\n    labs(x = x_label, y = \"age\") +\n    theme(\n      legend.position = \"top\",\n      axis.text.x = element_text(size = 12, color = \"black\"),\n      panel.grid.major.y = element_line(color = \"grey90\", linetype = \"dashed\")\n    )\n}\n\ndf_plot_split <- df_edu_trans %>%\n  filter(!is.na(job), !is.na(education), !is.na(y)) %>%\n  mutate(education = factor(education), y = factor(y))\n\np1_split <- plot_split_violin(df_plot_split, \"job\", \"age\", \"y\", \"job\") + \n  theme(axis.text.x = element_text(angle = 0))\n\np2_split <- plot_split_violin(df_plot_split, \"education\", \"age\", \"y\", \"education\") + \n  theme(legend.position = \"none\")\n\nfinal_split_plot <- (p1_split / p2_split) + \n  plot_layout(guides = \"collect\") & \n  theme(legend.position = \"top\")\n\nprint(final_split_plot)\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/rain_plot.png\", final_split_plot, width = 15, height = 7)\n```\n\n# 本次营销情况变量\n\n```{r}\n# 加载必要的包\nlibrary(tidyverse)\nlibrary(gghalves)\nlibrary(vcd)\nlibrary(ggpp)\n```\n\n## 基于month提取出年份和月通话量特征\n\n### 按年份与月份划分直方图\n\n```{r}\nmonth_levels <- c(\"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\", \n                  \"jul\", \"aug\", \"sep\", \"oct\", \"nov\", \"dec\")\n\ndf_plot <- df_marital_trans %>%\n  mutate(\n    month = factor(month, levels = month_levels),\n    month_num = as.numeric(month),\n    y = factor(y, levels = c(\"no\", \"yes\")) \n  ) %>%\n  # 还原年份逻辑\n  mutate(group_flag = ifelse(month_num < lag(month_num, default = 0), 1, 0)) %>%\n  mutate(year_offset = cumsum(group_flag)) %>%\n  mutate(year = 2008 + year_offset) %>%\n  filter(year %in% c(2008, 2009, 2010)) %>%\n  select(-group_flag, -year_offset)\n\ndf_summary <- df_plot %>%\n  group_by(year, month_num, y) %>%\n  summarise(count = n(), .groups = \"drop\") %>%\n  group_by(year, month_num) %>%\n  mutate(total_count = sum(count)) %>%\n  ungroup() %>%\n  mutate(global_rate = sum(count[y==\"yes\"]) / sum(count))\n\n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\") # 定义配色\n\np_left <- ggplot(df_summary, aes(x = month_num, y = count, fill = y)) +\n  geom_bar(stat = \"identity\", width = 0.8) +\n  geom_label(\n    aes(y = total_count, label = total_count), \n    data = df_summary %>% filter(y == \"no\"), # Hack: 只取一行数据用来画总标签\n    vjust = -0.2, size = 3, fill = \"white\", label.size = 0.1, alpha = 0.8\n  ) +\n  facet_grid(year ~ ., scales = \"free_y\") + \n  scale_x_continuous(breaks = 1:12, labels = 1:12) + # X轴显示 1-12\n  scale_fill_manual(values = my_colors) +\n  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) + # 顶部留白给标签\n  labs(y = \"number of observations\", x = NULL, title = \"Observations\") +\n  theme_classic() +\n  theme(\n    legend.position = \"none\", \n    strip.background = element_rect(fill = \"grey95\"), # 分面标签背景色\n    strip.text = element_text(size = 10, face = \"bold\"),\n    panel.grid.major.y = element_line(color = \"grey90\")\n  )\n\np_right <- ggplot(df_summary, aes(x = month_num, y = count, fill = y)) +\n  geom_bar(stat = \"identity\", position = \"fill\", width = 0.8) +\n  geom_hline(yintercept = mean(df_plot$y == \"yes\"), \n             linetype = \"dashed\", color = \"darkgray\", size = 0.7) +\n  facet_grid(year ~ .) +\n  scale_x_continuous(breaks = 1:12, labels = 1:12) +\n  scale_y_continuous(labels = scales::percent, expand = c(0,0)) + \n  scale_fill_manual(values = my_colors) +\n  labs(y = \"% of success in Observations\", x = \"month\", \n       fill = \"y\", # 图例标题\n       title = \"% of success in Observations\") +\n  theme_classic() +\n  theme(\n    strip.background = element_rect(fill = \"grey95\"),\n    strip.text = element_text(size = 10, face = \"bold\"),\n    legend.position = \"right\" \n  )\n\nfinal_plot <- p_left + p_right + \n  plot_layout(widths = c(1, 1)) # 设置左右宽度比例为 1:1\n\nprint(final_plot)\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/month_plot.png\", final_plot, width = 15, height = 5)\n```\n\n### 每月通话数量云雨图\n\n```{r}\ndf_rain_real <- df_summary %>%\n  uncount(weights = count) \n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\nggplot(df_rain_real, aes(x = y, y = total_count, fill = y)) + \n  \n  geom_half_violin(\n    side = \"r\", \n    position = position_nudge(x = 0.15), \n    adjust = 1.2,\n    alpha = 0.9,\n    trim = FALSE,      \n    color = \"black\",   \n    size = 0.3         \n  ) +\n  \n  geom_jitter(\n    aes(color = y),\n    shape = 21,       \n    size = 0.2,         \n    alpha = 0.6,    \n    position = position_jitterdodge(jitter.width = 0.3, jitter.height = 100, dodge.width = 1), \n    show.legend = FALSE\n  ) +\n\n  geom_boxplot(\n    width = 0.1,          \n    outlier.shape = NA,    \n    color = \"black\", \n    alpha = 1,\n    position = position_nudge(x = 0), \n    size = 0.3\n  ) +\n\n  coord_flip() +\n  \n  scale_fill_manual(values = my_colors) +\n  scale_color_manual(values = my_colors) +\n  \n  labs(\n    x = \"Result\",            \n    y = \"Monthly Contacts\",  \n    fill = NULL              \n  ) +\n  \n  theme_classic() + \n  theme(\n    legend.position = c(0.9, 0.9), \n    legend.direction = \"horizontal\",\n    axis.text = element_text(color = \"black\", size = 10)\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/month_rain_plot.png\", width = 11, height = 3, dpi = 300)\n```\n\n## 删除上次通话星期变量\n\n```{r}\ndf_week <- df_marital_trans %>%\n  mutate(\n    month = factor(month, levels = c(\"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\", \n                                     \"jul\", \"aug\", \"sep\", \"oct\", \"nov\", \"dec\")),\n    month_num = as.numeric(month),\n    day_of_week = factor(day_of_week, levels = c(\"mon\", \"tue\", \"wed\", \"thu\", \"fri\"))\n  ) %>%\n  mutate(group_flag = ifelse(month_num < lag(month_num, default = 0), 1, 0)) %>%\n  mutate(year_offset = cumsum(group_flag)) %>%\n  mutate(year = factor(2008 + year_offset)) %>% # 转为因子用于分面\n  filter(year %in% c(\"2008\", \"2009\", \"2010\"))   # 过滤掉异常年份\n\ntable(df_week$year, df_week$month)\n\nstruct_data <- structable(~ day_of_week + y + month + year, data = df_week)\n\nmosaic(struct_data,\n       shade = TRUE, \n       main = \"Mosaic Plot of Day of Week\",\n       direction = c(\"v\", \"v\", \"h\", \"h\"), # 切割方向：纵、纵、横、横\n       labeling = labeling_border(\n         rot_labels = c(0, 0, 0, 0),       # 标签旋转角度\n         just_labels = c(\"left\", \"left\", \"center\", \"center\"),\n         tl_labels = c(FALSE, TRUE)        # 是否显示顶部/左侧标签\n       ),\n       spacing = spacing_highlighting # 调整各个分割层级的间距 (Spacing)\n)\n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\np_right <- ggplot(df_week, aes(x = day_of_week, fill = y)) +\n  geom_bar(position = \"fill\", width = 0.8) +\n  facet_grid(month ~ year, switch = \"y\") +\n  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.5, 1)) +\n  scale_fill_manual(values = my_colors) +\n  \n  labs(x = \"day_of_week\", y = \"count (%)\", title = \"Distribution by Year & Month\") +\n  \n  theme_bw() + \n  theme(\n    panel.grid = element_blank(),\n    strip.background = element_rect(fill = \"white\", color = \"black\"),\n    strip.text = element_text(size = 8, face = \"bold\"),\n    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),\n    axis.text.y = element_text(size = 6),\n    legend.position = \"right\"\n  )\n\nprint(p_right)\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/week_plot.png\", width = 10, height = 10, dpi = 300)\n```\n\n## duration 按电话类型分组云雨图\n\n```{r}\ndf_duration <- df_week %>%\n  filter(duration <= 5000) %>% \n  filter(!is.na(contact)) %>%\n  mutate(y = factor(y, levels = c(\"no\", \"yes\"))) \n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\nggplot(df_duration, aes(x = contact, y = duration, fill = y)) +\n  \n  geom_half_violin(\n    side = \"r\", \n    position = position_nudge(x = 0.15), \n    scale = \"width\", \n    adjust = 1.2,     \n    trim = FALSE,     \n    alpha = 0.9, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  geom_point(\n    aes(color = y, y = duration - 110),\n    position = position_jitterdodge(\n      jitter.width = 0.5,  # 【宽度】：让雨下得更宽，散得更开\n      jitter.height = 0,   # 【精度】：数据值不准乱动\n      dodge.width = 0    # 【间距】：跟随分组\n    ),\n    size = 0.6, \n    alpha = 0.1, \n    shape = 16, # 实心小圆点\n    show.legend = FALSE\n  ) +\n  \n  geom_boxplot(\n    position = position_dodgenudge(width = 0.2, x = -0.02),\n    width = 0.15,      # 箱子宽度\n    outlier.shape = NA, \n    alpha = 1, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  coord_flip() + # 翻转坐标轴\n  scale_fill_manual(values = my_colors, name = \"Result:\") +\n  scale_color_manual(values = my_colors) +\n  labs(\n    x = \"contact\", \n    y = \"duration\"\n  ) +\n  theme_classic() +\n  theme(\n    legend.position = \"top\", # 图例在顶部\n    axis.text = element_text(color = \"black\", size = 10),\n    plot.margin = margin(10, 20, 10, 10)\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/contact_plot.png\", width = 12, height = 4, dpi = 300)\n```\n\n# 上次营销情况变量\n\n```{r}\n# 加载必要的包\nlibrary(vcd)\n```\n\n## previous与poutcome变量只保留其一\n\n```{r}\ndf_previous <- df_week %>%\n  mutate(poutcome = fct_recode(poutcome,\n    \"n\" = \"nonexistent\",  \n    \"f\" = \"failure\", \n    \"s\" = \"success\"\n  ))\n\nmosaic(~ previous + y + poutcome, \n       data = df_previous,\n       gp = shading_binary,\n       legend = FALSE,\n       main = \"\")\n```\n\n# 经济及社会环境变量\n\n## 经济指标与营销成果关系图\n\n```{r}\n# 1. 加载必要的包\nlibrary(ggplot2)\nlibrary(gghalves) \nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(lubridate)\nlibrary(scales)\n```\n\n## 经济变量云雨图\n\n```{r}\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\ndf_eco <- df_marital_trans %>%\n  select(y, emp.var.rate, cons.price.idx, cons.conf.idx, euribor3m, nr.employed) %>%\n  pivot_longer(\n    cols = -y,                 # 除了 y 以外的所有列都进行转换\n    names_to = \"indicator\",    # 新列名：存储指标名称\n    values_to = \"value\"        # 新列名：存储具体的数值\n  )\n\nggplot(df_eco, aes(x = y, y = value, fill = y)) +\n  \n  geom_half_violin(\n    side = \"r\", \n    position = position_nudge(x = 0.2), \n    scale = \"width\", \n    adjust = 1.2,      \n    trim = FALSE,      \n    alpha = 0.9, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  geom_point(\n    aes(color = y),\n    position = position_jitter(width = 0.15, height = 0), # 仅在水平方向抖动\n    size = 0.4, \n    alpha = 0.2, \n    shape = 16,\n    show.legend = FALSE\n  ) +\n  \n  geom_boxplot(\n    position = position_dodgenudge(width = 0.25, x = 0), # 与小提琴位置对齐\n    width = 0.1,       \n    outlier.shape = NA, \n    alpha = 1, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  facet_wrap(~indicator, scales = \"free\", ncol = 3) +\n  \n  coord_flip() + \n  scale_fill_manual(values = my_colors, name = \"Result:\") +\n  scale_color_manual(values = my_colors) +\n  labs(\n    x = \"Marketing Outcome (y)\", \n    y = \"Economic Indicator Value\",\n    title = \"Economic Indicators vs. Marketing Outcome\"\n  ) +\n  theme_classic() +\n  theme(\n    legend.position = \"top\",\n    axis.text = element_text(color = \"black\", size = 9),\n    strip.background = element_rect(fill = \"grey95\", color = NA), # 分面标题背景\n    strip.text = element_text(face = \"bold\", size = 10)           # 分面标题文字\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/eco_y.png\", width = 16, height = 8, dpi = 300)\n```\n\n## 经济变量时间序列图\n\n```{r}\nts_macro_data <- df_plot %>%\n  mutate(date = make_date(year, month_num, 1)) %>%\n  select(date, emp.var.rate, cons.price.idx, cons.conf.idx, euribor3m, nr.employed) %>%\n  distinct() %>%  # 去除重复行，只保留每个月唯一的经济指标值\n  \n  pivot_longer(\n    cols = -date, \n    names_to = \"indicator\", \n    values_to = \"value\"\n  )\n\nggplot(ts_macro_data, aes(x = date, y = value, color = indicator)) +\n  facet_wrap(~indicator, scales = \"free_y\", ncol = 1, strip.position = \"right\") +\n  geom_line(size = 1) +\n  scale_color_brewer(palette = \"Set1\", name = \"Economic Indicators\") +\n  scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 months\") +\n  \n  labs(\n    title = \"Macroeconomic Indicators Over Time\",\n    x = \"Date\",\n    y = \"Indicator Value\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\", \n    axis.text.x = element_text(angle = 45, hjust = 1), # X轴标签倾斜\n    strip.background = element_rect(fill = \"#E6F0F7\", color = NA),\n    strip.text = element_text(face = \"bold\", color = \"#143A72\")\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/ts_plot.png\", width = 12, height = 8, dpi = 300)\n```\n## 经济变量归一化处理\n\n```{r}\nts_macro_raw <- df_plot %>%\n  mutate(date = make_date(year, month_num, 1)) %>%\n  select(date, emp.var.rate, cons.price.idx, cons.conf.idx, euribor3m, nr.employed) %>%\n  distinct() %>% # 去重，只保留每月的唯一值\n  arrange(date)  # 按日期排序\n\nts_macro_norm <- ts_macro_raw %>% # 归一化处理\n  mutate(across(\n    .cols = where(is.numeric),       # 对所有数值型列进行操作\n    .fns = ~ rescale(.),             # 使用 scales 包的 rescale 函数归一化到 [0,1]\n    .names = \"{.col}\"                # 保持列名不变\n  ))\n\nplot_data <- ts_macro_norm %>%\n  pivot_longer(\n    cols = -date, \n    names_to = \"indicator\", \n    values_to = \"normalized_value\"\n  )\n\nggplot(plot_data, aes(x = date, y = normalized_value, color = indicator)) +\n  geom_line(size = 1, alpha = 0.8) +\n  scale_color_brewer(palette = \"Set1\", name = \"Economic Indicators\") +\n  \n  scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 months\") +\n  \n  labs(\n    title = \"Normalized Trends of Macroeconomic Indicators\",\n    x = \"Month\",\n    y = \"Normalized Value\"\n  ) +\n  \n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\",              # 图例放到底部\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    panel.grid.minor = element_blank()       # 去掉次网格线\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/ts2_plot.png\", width = 12, height = 8, dpi = 300)\n```\n\n\n# 缺失值处理\n\n```{r}\n# 加载必要的包\nlibrary(dplyr)\nlibrary(mice)\nlibrary(missForest) \nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(lattice)\nlibrary(caret)   \n```\n\n## 部分缺失值删除\n\n```{r}\n# 统计缺失值\nrow_missing_counts <- rowSums(is.na(df_previous))\ntable(row_missing_counts)\n\nna_summary <- df_previous %>%\n  summarise(across(everything(), ~ sum(is.na(.)))) %>%\n  pivot_longer(cols = everything(), names_to = \"variable\", values_to = \"na_count\") %>%\n  mutate(na_percent = round(na_count / nrow(df) * 100, 2)) %>%\n  filter(na_count > 0)   # 只保留有缺失的变量\nhead(na_summary) \n\n# 删除Job、Marital、Education 三个指标全部缺失的数据\ndf_clean <- df_previous %>%\n  filter(!(is.na(job) & is.na(marital) & is.na(education)))\n\n# 统计删除后缺失值\nrow_missing_counts <- rowSums(is.na(df_clean))\ntable(row_missing_counts)\n\nna_summary <- df_clean %>%\n  summarise(across(everything(), ~ sum(is.na(.)))) %>%\n  pivot_longer(cols = everything(), names_to = \"variable\", values_to = \"na_count\") %>%\n  mutate(na_percent = round(na_count / nrow(df) * 100, 2)) %>%\n  filter(na_count > 0)   # 只保留有缺失的变量\nhead(na_summary) \n```\n\n## 缺失值填补策略评估\n\n```{r}\ndf_nona <- df_clean %>% \n  drop_na()\ndf_truth <- na.omit(df_nona) \n\nset.seed(123)\nif(nrow(df_truth) > 5000) {\n  df_truth <- df_truth %>% sample_n(5000)\n}\n\ndf_missing_sim <- prodNA(df_truth, noNA = 0.1) # 生成含 10% 缺失值的数据集\nsum(is.na(df_missing_sim))\n\ndf_missing_sim <- df_missing_sim %>%\n  mutate(across(where(is.character), as.factor))\n\ndf_missing_sim <- as.data.frame(df_missing_sim)\n\n# 执行填补方案\n# 方案一：均值/众数填补\nget_mode <- function(v) {\n  uniqv <- unique(v)\n  uniqv[which.max(tabulate(match(v, uniqv)))]\n}\n\ndf_imp_simple <- df_missing_sim %>%\n  mutate(across(where(is.numeric), ~ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%\n  mutate(across(where(is.factor), ~ifelse(is.na(.), as.character(get_mode(na.omit(.))), as.character(.)))) %>%\n  mutate(across(where(is.character), as.factor))\n\n# MICE (PMM) 预测均值匹配\nmice_mod <- mice(df_missing_sim, method = 'pmm', m = 1, seed = 123, print = FALSE)\ndf_imp_pmm <- complete(mice_mod)\n\n# 方案三：随机森林\nrf_imp_res <- missForest(df_missing_sim, ntree = 100, verbose = FALSE) # ntree 树的数量，maxiter 迭代次数\ndf_imp_rf <- rf_imp_res$ximp\n\n# 计算评估指标\nevaluate_imputation <- function(true_data, imputed_data, na_indices, data_type) {\n  \n  if (data_type == \"numeric\") {\n    # 数值型计算 RMSE\n    diff <- true_data[na_indices] - imputed_data[na_indices]\n    rmse <- sqrt(mean(diff^2))\n    # 防止分母为0\n    range_val <- max(true_data, na.rm=T) - min(true_data, na.rm=T)\n    if(range_val == 0) range_val <- 1 \n    nrmse <- rmse / range_val\n    return(c(RMSE = rmse, NRMSE = nrmse))\n    \n  } else {\n    # 分类型计算错误率\n    # 【核心修改点】：强制转为 character 再比较，避开 level sets different 报错\n    v_true <- as.character(true_data[na_indices])\n    v_imp  <- as.character(imputed_data[na_indices])\n    \n    wrong_count <- sum(v_true != v_imp)\n    total_count <- length(v_true)\n    \n    error_rate <- wrong_count / total_count\n    return(c(Error_Rate = error_rate))\n  }\n}\n\n# --- 重新运行循环评估部分 ---\nresults <- list()\nna_matrix <- is.na(df_missing_sim)\n\n# 为了防止列名顺序问题，确保只遍历存在的列\ncommon_cols <- intersect(names(df_truth), names(df_imp_rf))\n\nfor (col in common_cols) {\n  # 只评估有缺失值的列\n  if (sum(na_matrix[, col]) > 0) {\n    \n    # 确定变量类型\n    is_num <- is.numeric(df_truth[[col]])\n    type <- if(is_num) \"numeric\" else \"categorical\"\n    \n    # 提取该列的缺失索引\n    idx <- which(na_matrix[, col])\n    \n    # 1. 评估简单填补\n    res_simple <- evaluate_imputation(df_truth[[col]], df_imp_simple[[col]], idx, type)\n    # 2. 评估 PMM\n    res_pmm <- evaluate_imputation(df_truth[[col]], df_imp_pmm[[col]], idx, type)\n    # 3. 评估 RF\n    res_rf <- evaluate_imputation(df_truth[[col]], df_imp_rf[[col]], idx, type)\n    \n    # 存储结果\n    results[[col]] <- data.frame(\n      Variable = col,\n      Type = type,\n      Method = c(\"Mean/Mode\", \"PMM\", \"RandomForest\"),\n      Metric_Value = c(res_simple[1], res_pmm[1], res_rf[1]) \n    )\n  }\n}\n\nfinal_evaluation <- do.call(rbind, results)\nrownames(final_evaluation) <- NULL \nprint(final_evaluation)\n\ntarget_var <- \"duration\" # 替换为你数据中缺失较多的数值变量名\n\n# 构建绘图数据\nplot_df <- rbind(\n  data.frame(val = df_truth[[target_var]], type = \"Original (Truth)\"),\n  data.frame(val = df_imp_simple[[target_var]], type = \"Mean/Mode\"),\n  data.frame(val = df_imp_pmm[[target_var]], type = \"PMM\"),\n  data.frame(val = df_imp_rf[[target_var]], type = \"Random Forest\")\n)\n\n# 绘制密度图\nggplot(plot_df, aes(x = val, color = type, fill = type)) +\n  geom_density(alpha = 0.3) +\n  theme_minimal() +\n  labs(title = paste(\"Imputation Distribution Comparison:\", target_var),\n       subtitle = \"Overlapping with 'Original' indicates better performance\") +\n  scale_color_brewer(palette = \"Set1\") +\n  scale_fill_brewer(palette = \"Set1\")\n```\n## 运行随机森林插补\n\n```{r}\n# 1. 数据准备\ndf_input <- df_clean %>%\n  mutate(across(where(is.character), as.factor)) %>%\n  as.data.frame()\n\n# 2. 正式运行随机森林填补\nprint(\"开始执行随机森林填补，请稍候...\")\nfinal_imputation_result <- missForest(df_input, ntree = 100, verbose = TRUE)\n\n# 3. 提取填补后的数据集\ndf_final <- final_imputation_result$ximp\n\n# 4. 最终检查\nprint(\"填补完成！\")\nprint(paste(\"剩余缺失值数量:\", sum(is.na(df_final)))) # 结果应为 0\n\nwrite.csv(df_final, \"/Users/inori/Desktop/数据分析/银行电话营销策略分析/bank_marketing_imputed.csv\", row.names = FALSE)\n```\n","srcMarkdownNoYaml":"\n\n## 1. 项目背景\n在这个项目中，我分析了葡萄牙银行机构的电话营销数据...\n\n## 2. 数据探索 (EDA)\n我使用 R 语言的 ggplot2 绘制了云雨图来观察通话时长分布：\n\n# 导入必要的包\n\n```{r}\nlibrary(tidyverse)\nlibrary(ggplot2)\nlibrary(scales)\n```\n\n# 导入数据\n\n```{r}\ndf <- read_delim(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/bank+marketing/bank-additional/bank-additional-full.csv\", delim = \";\", show_col_types = FALSE)\nhead(df)\n```\n\n# 绘制变量分布图\n## 绘制离散型变量分布图（堆叠条形图）\n\n```{r}\nplot_data <- df %>% \n  select(where(is.character)) %>%\n  pivot_longer(cols = everything(), names_to = \"variable\", values_to = \"category\") %>%\n  group_by(variable, category) %>%\n  summarise(count = n(), .groups = \"drop_last\") %>%\n  mutate(\n    prop = count / sum(count),\n    label_text = ifelse(prop > 0.15, category, \"\") # 只显示占比大于15%的标签\n  ) %>%\n  \n  arrange(variable, desc(prop)) %>% # 按占比降序排列\n  mutate(rank = as.factor(row_number())) %>% \n  ungroup()\n\n# 绘图\nmy_blue_palette <- colorRampPalette(RColorBrewer::brewer.pal(9, \"Blues\")) # 设置调色盘\n\nggplot(plot_data, aes(x = prop, y = variable, fill = rank)) +\n  geom_col(width = 0.7, color = \"white\", alpha = 0.95) +\n  \n  geom_text(aes(label = label_text), \n            position = position_stack(vjust = 0.5), \n            size = 5, color = \"white\", fontface = \"bold\") +\n  \n  scale_fill_manual(values = rev(my_blue_palette(length(unique(plot_data$rank))))) +\n  \n  scale_x_continuous(labels = percent, expand = c(0,0)) +\n  labs(title = NULL, \n       x = NULL, y = NULL) +\n  theme_minimal() +\n  theme(\n    legend.position = \"none\",\n    panel.grid = element_blank(),\n    axis.text.y = element_text(size = 11, face = \"bold\", color = \"#2C3E50\"),\n    axis.text.x = element_text(color = \"grey60\")\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/discrete.png\", width = 12, height = 8, dpi = 300)\n```\n\n## 绘制连续型变量分布图\n\n```{r}\nplot_data_cont_stacked <- df %>%\n  select(where(is.numeric), y) %>%   \n  pivot_longer(cols = -y,            \n               names_to = \"variable\", \n               values_to = \"value\")\n\nggplot(plot_data_cont_stacked, aes(x = value, fill = y)) +\n  geom_histogram(bins = 30,            \n                 alpha = 1,          \n                 position = \"stack\") + \n  scale_fill_manual(values = c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\"), \n                    name = \"y\") +\n  facet_wrap(~ variable, scales = \"free\", ncol = 5) +\n  labs(title = NULL, \n       subtitle = NULL,\n       x = NULL, \n       y = NULL) +\n  theme_minimal() + \n  theme(\n    plot.title = element_text(face = \"bold\", size = 14, color = \"#2C3E50\"),\n    legend.position = \"bottom\",                      \n    strip.background = element_rect(fill = \"#EBF5FB\", color = NA), \n    strip.text = element_text(color = \"#143A72\", face = \"bold\"),   \n    panel.grid = element_blank(),\n    panel.border = element_rect(color = \"black\", fill = NA, linewidth = 0.5) \n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/continuous.png\", width = 12, height = 5, dpi = 300)\n```\n\n# 初步数据清洗\n\n```{r}\n# 1. 检查缺失值/数据去重\n  missing_values <- colSums(is.na(df)) # 检查每一列的缺失值数量\n  print(missing_values)\n  \n  duplicate_rows <- sum(duplicated(df)) # 检查是否存在重复行\n  print(paste(\"重复行数量:\", duplicate_rows))\n  \n  df_clean <- df %>% distinct() # 如果有重复行，删除\n\n# 2. 数据转义\ndf_trans <- df_clean %>%\n  mutate(\n    across(where(is.character), \\(x) na_if(x, \"unknown\")), # 将所有字符型变量中的 \"unknown\" 替换为 NA\n    pdays = na_if(pdays, 999) # \"pdays\" 中的 \"999\" 替换为 NA\n  )\n\n# 检查结果\ndf_trans %>%\n  select(job, default, housing, loan, pdays, marital, education) %>%\n  head(10)\n```\n\n# 探索性数据分析\n\n```{r}\n# 加载必要的包\nlibrary(patchwork)\nlibrary(tidyverse)\nlibrary(scales)\nlibrary(ggridges)\nlibrary(gghalves)\n```\n\n## 个人信息类\n\n```{r}\ntarget_variables <- c(\"job\", \"education\", \"marital\", \"default\", \"housing\", \"loan\")\n\nfor (var in target_variables) {\n  \n  # 预处理数据并计算占比，用于排序\n  rank_data <- df_trans %>%\n    filter(!is.na(!!sym(var))) %>%\n    count(!!sym(var)) %>%\n    arrange(n) # 从小到大排序\n  \n  # 准备绘图数据\n  plot_data <- df_trans %>%\n    select(y, !!sym(var)) %>%\n    mutate(!!sym(var) := fct_na_value_to_level(factor(!!sym(var)), level = \"NA\")) %>%\n    mutate(!!sym(var) := fct_reorder(!!sym(var), .x = (!!sym(var) == \"NA\"), .desc = FALSE)) \n    \n  non_na_levels <- rank_data[[var]]\n  plot_data <- plot_data %>%\n    mutate(!!sym(var) := fct_relevel(!!sym(var), \"NA\", after = 0)) %>%\n    mutate(!!sym(var) := fct_relevel(!!sym(var), as.character(non_na_levels), after = 1))\n\n  # 构造颜色向量\n  levels_present <- levels(plot_data[[var]])\n  num_non_na <- sum(levels_present != \"NA\")\n  custom_colors <- c(\"#D3D3D3\", my_blue_palette(num_non_na)) \n  names(custom_colors) <- levels_present\n\n  # 绘图\n  p <- ggplot(plot_data, aes(x = y, fill = !!sym(var))) +\n    geom_bar(position = \"fill\", color = \"black\", linewidth = 0.2) + \n    geom_text(\n      aes(label = !!sym(var)),\n      stat = \"count\", \n      position = position_fill(vjust = 0.5),\n      size = 3,\n      color = \"black\",\n      fontface = \"bold\",\n      check_overlap = TRUE\n    ) +\n    scale_fill_manual(values = custom_colors) +\n    scale_y_continuous(labels = scales::percent) +\n    theme_minimal() +\n    labs(title = NULL,\n         x = \"y\",\n         y = paste(\"% of\", var),\n         fill = var)\n  print(p)\n  \n  file_name <- paste0(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/plot_\", var, \".png\")\n  ggsave(filename = file_name, plot = p, width = 8, height = 6, dpi = 300)\n}\n```\n\n### Default 变量的缺失视作一类，并重新分为没有违约记录和其他\n\n```{r}\npng(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/Default_Mosaic_Comparison.png\", width = 2000, height = 1000, res = 200)\n\npar(mfrow = c(1, 2))\n\ncounts_before <- table(df_trans$default, df_trans$y, useNA = \"ifany\")\nrownames(counts_before)[is.na(rownames(counts_before))] <- \"NA\"\n\n# plot1\nmosaicplot(counts_before,\n           main = \"Before Reclassify\",\n           xlab = \"default\", \n           ylab = \"y\",\n           color = c(\"#C6DBEF\", \"#1D3567\"), \n           border = \"black\",\n           las = 1)\n\n# 合并default变量\ndf_trans <- df_trans %>%\n  mutate(\n    default = default %>%\n      fct_na_value_to_level(level = \"other\") %>%\n      fct_collapse(other = \"yes\")\n  )\n\ncounts_trans <- table(df_trans$default, df_trans$y, useNA = \"ifany\")\n\n# plot2\nmosaicplot(counts_trans,\n           main = \"After Reclassify\",\n           xlab = \"default\", \n           ylab = \"y\",\n           color = c(\"#C6DBEF\", \"#1D3567\"), \n           border = \"black\",\n           las = 1)\ndev.off()\n\npar(mfrow = c(1, 1))\n```\n\n### education变量类型转换\n\n```{r}\n# 1. 绘制education和job变量热力图\nheatmap_absolute <- df_trans %>%\n  select(job, education) %>%\n  mutate(across(c(job, education), ~fct_na_value_to_level(factor(.), level = \"NA\"))) %>%\n  count(job, education) %>%\n  ungroup() %>%\n  mutate(prop = n / sum(n))\n\nggplot(heatmap_absolute, aes(x = education, y = job, fill = prop)) +\n  geom_tile(color = \"white\", lwd = 0.5) +\n  \n  geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),\n            color = ifelse(heatmap_absolute$prop > max(heatmap_absolute$prop) / 2, \"white\", \"black\"),\n            size = 3) +\n  \n  scale_fill_distiller(palette = \"Blues\",\n                       direction = 1,\n                       labels = scales::percent,\n                       name = \"Percentage\") +\n  theme_minimal() +\n  labs(title = \"\",\n       x = \"education\",\n       y = \"job\") +\n  theme(\n    panel.grid = element_blank(), # 去掉所有网格线\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    legend.position = \"none\"\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/heatmap.png\", width = 12, height = 10, dpi = 300)\n\n# 2. education变量转换\ndf_edu_trans <- df_trans %>%\n  mutate(education = case_match(education,\n     \"illiterate\" ~ 1,\n     \"basic.4y\" ~ 4,\n     \"basic.6y\" ~ 6,\n     \"basic.9y\" ~ 9,\n     \"high.school\" ~ 12,\n     \"professional.course\" ~ 14,\n     \"university.degree\" ~ 16,\n     .default = NA \n  ))\n\n# 3. 绘制山峦图\ndf_plot_ridges <- df_edu_trans %>%\n  filter(!is.na(job), !is.na(education)) %>%\n  mutate(job = fct_reorder(job, education, .fun = median))\n\nggplot(df_plot_ridges, aes(x = education, y = job, fill = after_stat(x))) + \n  geom_density_ridges_gradient(scale = 1.5, rel_min_height = 0.01) +\n  \n  scale_fill_distiller(palette = \"Blues\",\n                       direction = 1,\n                       name = \"Years\") +\n  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16)) + \n  theme_ridges(font_size = 12, grid = FALSE) +\n  labs(title = \"\",\n       x = \"Years of Education\",\n       y = \"Job\") +\n  theme(\n    axis.title.x = element_text(hjust = 0.5, size = 14),\n    axis.title.y = element_text(hjust = 0.5, size = 14),\n    legend.position = \"none\"\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/peak_plot.png\", width = 12, height = 8, dpi = 300)\n```\n\n### marital变量重新划分\n\n```{r}\n# 1. 生成交叉表（包含 NA）\ncounts_marital <- table(df_edu_trans$marital, df_edu_trans$y, useNA = \"ifany\")\n\n# 2. 把 <NA> 行名改成字符串 \"NA\"\nrownames(counts_marital)[is.na(rownames(counts_marital))] <- \"NA\"\n\n# 3. 绘图\nmosaicplot(counts_marital,\n           main = \"\",\n           xlab = \"y\", \n           ylab = \"Marital Status\",  \n           color = c(\"#C6DBEF\", \"#1D3567\"), \n           border = \"black\",  # 白色分割线，现代感强\n           lwd = 1,           # 边框粗细\n           las = 1            # 纵轴标签水平显示\n)\n\n# 4. marital变量划分为：结过婚(married & divorced, 1) vs 没结过婚(single, 0)\ndf_marital_trans <- df_edu_trans %>%\n  mutate(\n    marital = fct_collapse(\n      marital,\n      \"1\" = c(\"married\", \"divorced\"),\n      \"0\" = \"single\"\n    )\n  )\nhead(df_marital_trans)\n```\n\n### 保留age变量数值类型不做分箱（云雨图）\n\n```{r}\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\nnudge_gap <- 0.2\n\nplot_split_violin <- function(data, x_var, y_var, group_var, x_label) {\n  \n  ggplot(data, aes(x = .data[[x_var]], y = .data[[y_var]], fill = .data[[group_var]])) +\n    \n    geom_half_violin(\n      data = data %>% filter(.data[[group_var]] == \"yes\"),\n      aes(fill = .data[[group_var]]),\n      side = \"r\",   \n      position = position_nudge(x = nudge_gap),\n      scale = \"width\", alpha = 0.9, color = \"black\", lwd = 0.5\n    ) +\n    \n    geom_half_violin(\n      data = data %>% filter(.data[[group_var]] == \"no\"),\n      aes(fill = .data[[group_var]]),\n      side = \"r\",\n      position = position_nudge(x = nudge_gap),\n      scale = \"width\", alpha = 0.9, color = \"black\", lwd = 0.5\n    ) +\n    \n    geom_point(\n    aes(color = .data[[group_var]]), \n    position = position_jitterdodge(jitter.width = 0.5, dodge.width = 0), \n    size = 0.3, alpha = 0.2, shape = 21, color = \"white\", show.legend = FALSE\n    ) +\n    \n    geom_boxplot(\n      width = 0.15,  \n      position = position_dodge(width = 0.2),\n      outlier.shape = NA, \n      alpha = 1, color = \"black\", lwd = 0.3, show.legend = TRUE\n    ) +\n    \n    stat_summary(\n      fun = mean, geom = \"point\", shape = 23, size = 1.5, fill = \"white\",\n      position = position_dodge(width = 0.15), show.legend = FALSE\n    ) +\n\n    scale_fill_manual(values = my_colors) +\n    theme_classic() +\n    labs(x = x_label, y = \"age\") +\n    theme(\n      legend.position = \"top\",\n      axis.text.x = element_text(size = 12, color = \"black\"),\n      panel.grid.major.y = element_line(color = \"grey90\", linetype = \"dashed\")\n    )\n}\n\ndf_plot_split <- df_edu_trans %>%\n  filter(!is.na(job), !is.na(education), !is.na(y)) %>%\n  mutate(education = factor(education), y = factor(y))\n\np1_split <- plot_split_violin(df_plot_split, \"job\", \"age\", \"y\", \"job\") + \n  theme(axis.text.x = element_text(angle = 0))\n\np2_split <- plot_split_violin(df_plot_split, \"education\", \"age\", \"y\", \"education\") + \n  theme(legend.position = \"none\")\n\nfinal_split_plot <- (p1_split / p2_split) + \n  plot_layout(guides = \"collect\") & \n  theme(legend.position = \"top\")\n\nprint(final_split_plot)\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/rain_plot.png\", final_split_plot, width = 15, height = 7)\n```\n\n# 本次营销情况变量\n\n```{r}\n# 加载必要的包\nlibrary(tidyverse)\nlibrary(gghalves)\nlibrary(vcd)\nlibrary(ggpp)\n```\n\n## 基于month提取出年份和月通话量特征\n\n### 按年份与月份划分直方图\n\n```{r}\nmonth_levels <- c(\"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\", \n                  \"jul\", \"aug\", \"sep\", \"oct\", \"nov\", \"dec\")\n\ndf_plot <- df_marital_trans %>%\n  mutate(\n    month = factor(month, levels = month_levels),\n    month_num = as.numeric(month),\n    y = factor(y, levels = c(\"no\", \"yes\")) \n  ) %>%\n  # 还原年份逻辑\n  mutate(group_flag = ifelse(month_num < lag(month_num, default = 0), 1, 0)) %>%\n  mutate(year_offset = cumsum(group_flag)) %>%\n  mutate(year = 2008 + year_offset) %>%\n  filter(year %in% c(2008, 2009, 2010)) %>%\n  select(-group_flag, -year_offset)\n\ndf_summary <- df_plot %>%\n  group_by(year, month_num, y) %>%\n  summarise(count = n(), .groups = \"drop\") %>%\n  group_by(year, month_num) %>%\n  mutate(total_count = sum(count)) %>%\n  ungroup() %>%\n  mutate(global_rate = sum(count[y==\"yes\"]) / sum(count))\n\n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\") # 定义配色\n\np_left <- ggplot(df_summary, aes(x = month_num, y = count, fill = y)) +\n  geom_bar(stat = \"identity\", width = 0.8) +\n  geom_label(\n    aes(y = total_count, label = total_count), \n    data = df_summary %>% filter(y == \"no\"), # Hack: 只取一行数据用来画总标签\n    vjust = -0.2, size = 3, fill = \"white\", label.size = 0.1, alpha = 0.8\n  ) +\n  facet_grid(year ~ ., scales = \"free_y\") + \n  scale_x_continuous(breaks = 1:12, labels = 1:12) + # X轴显示 1-12\n  scale_fill_manual(values = my_colors) +\n  scale_y_continuous(expand = expansion(mult = c(0, 0.2))) + # 顶部留白给标签\n  labs(y = \"number of observations\", x = NULL, title = \"Observations\") +\n  theme_classic() +\n  theme(\n    legend.position = \"none\", \n    strip.background = element_rect(fill = \"grey95\"), # 分面标签背景色\n    strip.text = element_text(size = 10, face = \"bold\"),\n    panel.grid.major.y = element_line(color = \"grey90\")\n  )\n\np_right <- ggplot(df_summary, aes(x = month_num, y = count, fill = y)) +\n  geom_bar(stat = \"identity\", position = \"fill\", width = 0.8) +\n  geom_hline(yintercept = mean(df_plot$y == \"yes\"), \n             linetype = \"dashed\", color = \"darkgray\", size = 0.7) +\n  facet_grid(year ~ .) +\n  scale_x_continuous(breaks = 1:12, labels = 1:12) +\n  scale_y_continuous(labels = scales::percent, expand = c(0,0)) + \n  scale_fill_manual(values = my_colors) +\n  labs(y = \"% of success in Observations\", x = \"month\", \n       fill = \"y\", # 图例标题\n       title = \"% of success in Observations\") +\n  theme_classic() +\n  theme(\n    strip.background = element_rect(fill = \"grey95\"),\n    strip.text = element_text(size = 10, face = \"bold\"),\n    legend.position = \"right\" \n  )\n\nfinal_plot <- p_left + p_right + \n  plot_layout(widths = c(1, 1)) # 设置左右宽度比例为 1:1\n\nprint(final_plot)\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/month_plot.png\", final_plot, width = 15, height = 5)\n```\n\n### 每月通话数量云雨图\n\n```{r}\ndf_rain_real <- df_summary %>%\n  uncount(weights = count) \n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\nggplot(df_rain_real, aes(x = y, y = total_count, fill = y)) + \n  \n  geom_half_violin(\n    side = \"r\", \n    position = position_nudge(x = 0.15), \n    adjust = 1.2,\n    alpha = 0.9,\n    trim = FALSE,      \n    color = \"black\",   \n    size = 0.3         \n  ) +\n  \n  geom_jitter(\n    aes(color = y),\n    shape = 21,       \n    size = 0.2,         \n    alpha = 0.6,    \n    position = position_jitterdodge(jitter.width = 0.3, jitter.height = 100, dodge.width = 1), \n    show.legend = FALSE\n  ) +\n\n  geom_boxplot(\n    width = 0.1,          \n    outlier.shape = NA,    \n    color = \"black\", \n    alpha = 1,\n    position = position_nudge(x = 0), \n    size = 0.3\n  ) +\n\n  coord_flip() +\n  \n  scale_fill_manual(values = my_colors) +\n  scale_color_manual(values = my_colors) +\n  \n  labs(\n    x = \"Result\",            \n    y = \"Monthly Contacts\",  \n    fill = NULL              \n  ) +\n  \n  theme_classic() + \n  theme(\n    legend.position = c(0.9, 0.9), \n    legend.direction = \"horizontal\",\n    axis.text = element_text(color = \"black\", size = 10)\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/month_rain_plot.png\", width = 11, height = 3, dpi = 300)\n```\n\n## 删除上次通话星期变量\n\n```{r}\ndf_week <- df_marital_trans %>%\n  mutate(\n    month = factor(month, levels = c(\"jan\", \"feb\", \"mar\", \"apr\", \"may\", \"jun\", \n                                     \"jul\", \"aug\", \"sep\", \"oct\", \"nov\", \"dec\")),\n    month_num = as.numeric(month),\n    day_of_week = factor(day_of_week, levels = c(\"mon\", \"tue\", \"wed\", \"thu\", \"fri\"))\n  ) %>%\n  mutate(group_flag = ifelse(month_num < lag(month_num, default = 0), 1, 0)) %>%\n  mutate(year_offset = cumsum(group_flag)) %>%\n  mutate(year = factor(2008 + year_offset)) %>% # 转为因子用于分面\n  filter(year %in% c(\"2008\", \"2009\", \"2010\"))   # 过滤掉异常年份\n\ntable(df_week$year, df_week$month)\n\nstruct_data <- structable(~ day_of_week + y + month + year, data = df_week)\n\nmosaic(struct_data,\n       shade = TRUE, \n       main = \"Mosaic Plot of Day of Week\",\n       direction = c(\"v\", \"v\", \"h\", \"h\"), # 切割方向：纵、纵、横、横\n       labeling = labeling_border(\n         rot_labels = c(0, 0, 0, 0),       # 标签旋转角度\n         just_labels = c(\"left\", \"left\", \"center\", \"center\"),\n         tl_labels = c(FALSE, TRUE)        # 是否显示顶部/左侧标签\n       ),\n       spacing = spacing_highlighting # 调整各个分割层级的间距 (Spacing)\n)\n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\np_right <- ggplot(df_week, aes(x = day_of_week, fill = y)) +\n  geom_bar(position = \"fill\", width = 0.8) +\n  facet_grid(month ~ year, switch = \"y\") +\n  scale_y_continuous(labels = scales::percent, breaks = c(0, 0.5, 1)) +\n  scale_fill_manual(values = my_colors) +\n  \n  labs(x = \"day_of_week\", y = \"count (%)\", title = \"Distribution by Year & Month\") +\n  \n  theme_bw() + \n  theme(\n    panel.grid = element_blank(),\n    strip.background = element_rect(fill = \"white\", color = \"black\"),\n    strip.text = element_text(size = 8, face = \"bold\"),\n    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),\n    axis.text.y = element_text(size = 6),\n    legend.position = \"right\"\n  )\n\nprint(p_right)\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/week_plot.png\", width = 10, height = 10, dpi = 300)\n```\n\n## duration 按电话类型分组云雨图\n\n```{r}\ndf_duration <- df_week %>%\n  filter(duration <= 5000) %>% \n  filter(!is.na(contact)) %>%\n  mutate(y = factor(y, levels = c(\"no\", \"yes\"))) \n\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\nggplot(df_duration, aes(x = contact, y = duration, fill = y)) +\n  \n  geom_half_violin(\n    side = \"r\", \n    position = position_nudge(x = 0.15), \n    scale = \"width\", \n    adjust = 1.2,     \n    trim = FALSE,     \n    alpha = 0.9, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  geom_point(\n    aes(color = y, y = duration - 110),\n    position = position_jitterdodge(\n      jitter.width = 0.5,  # 【宽度】：让雨下得更宽，散得更开\n      jitter.height = 0,   # 【精度】：数据值不准乱动\n      dodge.width = 0    # 【间距】：跟随分组\n    ),\n    size = 0.6, \n    alpha = 0.1, \n    shape = 16, # 实心小圆点\n    show.legend = FALSE\n  ) +\n  \n  geom_boxplot(\n    position = position_dodgenudge(width = 0.2, x = -0.02),\n    width = 0.15,      # 箱子宽度\n    outlier.shape = NA, \n    alpha = 1, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  coord_flip() + # 翻转坐标轴\n  scale_fill_manual(values = my_colors, name = \"Result:\") +\n  scale_color_manual(values = my_colors) +\n  labs(\n    x = \"contact\", \n    y = \"duration\"\n  ) +\n  theme_classic() +\n  theme(\n    legend.position = \"top\", # 图例在顶部\n    axis.text = element_text(color = \"black\", size = 10),\n    plot.margin = margin(10, 20, 10, 10)\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/contact_plot.png\", width = 12, height = 4, dpi = 300)\n```\n\n# 上次营销情况变量\n\n```{r}\n# 加载必要的包\nlibrary(vcd)\n```\n\n## previous与poutcome变量只保留其一\n\n```{r}\ndf_previous <- df_week %>%\n  mutate(poutcome = fct_recode(poutcome,\n    \"n\" = \"nonexistent\",  \n    \"f\" = \"failure\", \n    \"s\" = \"success\"\n  ))\n\nmosaic(~ previous + y + poutcome, \n       data = df_previous,\n       gp = shading_binary,\n       legend = FALSE,\n       main = \"\")\n```\n\n# 经济及社会环境变量\n\n## 经济指标与营销成果关系图\n\n```{r}\n# 1. 加载必要的包\nlibrary(ggplot2)\nlibrary(gghalves) \nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(lubridate)\nlibrary(scales)\n```\n\n## 经济变量云雨图\n\n```{r}\nmy_colors <- c(\"no\" = \"#C6DBEF\", \"yes\" = \"#143A72\")\n\ndf_eco <- df_marital_trans %>%\n  select(y, emp.var.rate, cons.price.idx, cons.conf.idx, euribor3m, nr.employed) %>%\n  pivot_longer(\n    cols = -y,                 # 除了 y 以外的所有列都进行转换\n    names_to = \"indicator\",    # 新列名：存储指标名称\n    values_to = \"value\"        # 新列名：存储具体的数值\n  )\n\nggplot(df_eco, aes(x = y, y = value, fill = y)) +\n  \n  geom_half_violin(\n    side = \"r\", \n    position = position_nudge(x = 0.2), \n    scale = \"width\", \n    adjust = 1.2,      \n    trim = FALSE,      \n    alpha = 0.9, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  geom_point(\n    aes(color = y),\n    position = position_jitter(width = 0.15, height = 0), # 仅在水平方向抖动\n    size = 0.4, \n    alpha = 0.2, \n    shape = 16,\n    show.legend = FALSE\n  ) +\n  \n  geom_boxplot(\n    position = position_dodgenudge(width = 0.25, x = 0), # 与小提琴位置对齐\n    width = 0.1,       \n    outlier.shape = NA, \n    alpha = 1, \n    color = \"black\", \n    size = 0.3\n  ) +\n  \n  facet_wrap(~indicator, scales = \"free\", ncol = 3) +\n  \n  coord_flip() + \n  scale_fill_manual(values = my_colors, name = \"Result:\") +\n  scale_color_manual(values = my_colors) +\n  labs(\n    x = \"Marketing Outcome (y)\", \n    y = \"Economic Indicator Value\",\n    title = \"Economic Indicators vs. Marketing Outcome\"\n  ) +\n  theme_classic() +\n  theme(\n    legend.position = \"top\",\n    axis.text = element_text(color = \"black\", size = 9),\n    strip.background = element_rect(fill = \"grey95\", color = NA), # 分面标题背景\n    strip.text = element_text(face = \"bold\", size = 10)           # 分面标题文字\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/eco_y.png\", width = 16, height = 8, dpi = 300)\n```\n\n## 经济变量时间序列图\n\n```{r}\nts_macro_data <- df_plot %>%\n  mutate(date = make_date(year, month_num, 1)) %>%\n  select(date, emp.var.rate, cons.price.idx, cons.conf.idx, euribor3m, nr.employed) %>%\n  distinct() %>%  # 去除重复行，只保留每个月唯一的经济指标值\n  \n  pivot_longer(\n    cols = -date, \n    names_to = \"indicator\", \n    values_to = \"value\"\n  )\n\nggplot(ts_macro_data, aes(x = date, y = value, color = indicator)) +\n  facet_wrap(~indicator, scales = \"free_y\", ncol = 1, strip.position = \"right\") +\n  geom_line(size = 1) +\n  scale_color_brewer(palette = \"Set1\", name = \"Economic Indicators\") +\n  scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 months\") +\n  \n  labs(\n    title = \"Macroeconomic Indicators Over Time\",\n    x = \"Date\",\n    y = \"Indicator Value\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\", \n    axis.text.x = element_text(angle = 45, hjust = 1), # X轴标签倾斜\n    strip.background = element_rect(fill = \"#E6F0F7\", color = NA),\n    strip.text = element_text(face = \"bold\", color = \"#143A72\")\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/ts_plot.png\", width = 12, height = 8, dpi = 300)\n```\n## 经济变量归一化处理\n\n```{r}\nts_macro_raw <- df_plot %>%\n  mutate(date = make_date(year, month_num, 1)) %>%\n  select(date, emp.var.rate, cons.price.idx, cons.conf.idx, euribor3m, nr.employed) %>%\n  distinct() %>% # 去重，只保留每月的唯一值\n  arrange(date)  # 按日期排序\n\nts_macro_norm <- ts_macro_raw %>% # 归一化处理\n  mutate(across(\n    .cols = where(is.numeric),       # 对所有数值型列进行操作\n    .fns = ~ rescale(.),             # 使用 scales 包的 rescale 函数归一化到 [0,1]\n    .names = \"{.col}\"                # 保持列名不变\n  ))\n\nplot_data <- ts_macro_norm %>%\n  pivot_longer(\n    cols = -date, \n    names_to = \"indicator\", \n    values_to = \"normalized_value\"\n  )\n\nggplot(plot_data, aes(x = date, y = normalized_value, color = indicator)) +\n  geom_line(size = 1, alpha = 0.8) +\n  scale_color_brewer(palette = \"Set1\", name = \"Economic Indicators\") +\n  \n  scale_x_date(date_labels = \"%Y-%m\", date_breaks = \"1 months\") +\n  \n  labs(\n    title = \"Normalized Trends of Macroeconomic Indicators\",\n    x = \"Month\",\n    y = \"Normalized Value\"\n  ) +\n  \n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\",              # 图例放到底部\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    panel.grid.minor = element_blank()       # 去掉次网格线\n  )\n\nggsave(\"/Users/inori/Desktop/数据分析/银行电话营销策略分析/ts2_plot.png\", width = 12, height = 8, dpi = 300)\n```\n\n\n# 缺失值处理\n\n```{r}\n# 加载必要的包\nlibrary(dplyr)\nlibrary(mice)\nlibrary(missForest) \nlibrary(ggplot2)\nlibrary(tidyr)\nlibrary(lattice)\nlibrary(caret)   \n```\n\n## 部分缺失值删除\n\n```{r}\n# 统计缺失值\nrow_missing_counts <- rowSums(is.na(df_previous))\ntable(row_missing_counts)\n\nna_summary <- df_previous %>%\n  summarise(across(everything(), ~ sum(is.na(.)))) %>%\n  pivot_longer(cols = everything(), names_to = \"variable\", values_to = \"na_count\") %>%\n  mutate(na_percent = round(na_count / nrow(df) * 100, 2)) %>%\n  filter(na_count > 0)   # 只保留有缺失的变量\nhead(na_summary) \n\n# 删除Job、Marital、Education 三个指标全部缺失的数据\ndf_clean <- df_previous %>%\n  filter(!(is.na(job) & is.na(marital) & is.na(education)))\n\n# 统计删除后缺失值\nrow_missing_counts <- rowSums(is.na(df_clean))\ntable(row_missing_counts)\n\nna_summary <- df_clean %>%\n  summarise(across(everything(), ~ sum(is.na(.)))) %>%\n  pivot_longer(cols = everything(), names_to = \"variable\", values_to = \"na_count\") %>%\n  mutate(na_percent = round(na_count / nrow(df) * 100, 2)) %>%\n  filter(na_count > 0)   # 只保留有缺失的变量\nhead(na_summary) \n```\n\n## 缺失值填补策略评估\n\n```{r}\ndf_nona <- df_clean %>% \n  drop_na()\ndf_truth <- na.omit(df_nona) \n\nset.seed(123)\nif(nrow(df_truth) > 5000) {\n  df_truth <- df_truth %>% sample_n(5000)\n}\n\ndf_missing_sim <- prodNA(df_truth, noNA = 0.1) # 生成含 10% 缺失值的数据集\nsum(is.na(df_missing_sim))\n\ndf_missing_sim <- df_missing_sim %>%\n  mutate(across(where(is.character), as.factor))\n\ndf_missing_sim <- as.data.frame(df_missing_sim)\n\n# 执行填补方案\n# 方案一：均值/众数填补\nget_mode <- function(v) {\n  uniqv <- unique(v)\n  uniqv[which.max(tabulate(match(v, uniqv)))]\n}\n\ndf_imp_simple <- df_missing_sim %>%\n  mutate(across(where(is.numeric), ~ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%\n  mutate(across(where(is.factor), ~ifelse(is.na(.), as.character(get_mode(na.omit(.))), as.character(.)))) %>%\n  mutate(across(where(is.character), as.factor))\n\n# MICE (PMM) 预测均值匹配\nmice_mod <- mice(df_missing_sim, method = 'pmm', m = 1, seed = 123, print = FALSE)\ndf_imp_pmm <- complete(mice_mod)\n\n# 方案三：随机森林\nrf_imp_res <- missForest(df_missing_sim, ntree = 100, verbose = FALSE) # ntree 树的数量，maxiter 迭代次数\ndf_imp_rf <- rf_imp_res$ximp\n\n# 计算评估指标\nevaluate_imputation <- function(true_data, imputed_data, na_indices, data_type) {\n  \n  if (data_type == \"numeric\") {\n    # 数值型计算 RMSE\n    diff <- true_data[na_indices] - imputed_data[na_indices]\n    rmse <- sqrt(mean(diff^2))\n    # 防止分母为0\n    range_val <- max(true_data, na.rm=T) - min(true_data, na.rm=T)\n    if(range_val == 0) range_val <- 1 \n    nrmse <- rmse / range_val\n    return(c(RMSE = rmse, NRMSE = nrmse))\n    \n  } else {\n    # 分类型计算错误率\n    # 【核心修改点】：强制转为 character 再比较，避开 level sets different 报错\n    v_true <- as.character(true_data[na_indices])\n    v_imp  <- as.character(imputed_data[na_indices])\n    \n    wrong_count <- sum(v_true != v_imp)\n    total_count <- length(v_true)\n    \n    error_rate <- wrong_count / total_count\n    return(c(Error_Rate = error_rate))\n  }\n}\n\n# --- 重新运行循环评估部分 ---\nresults <- list()\nna_matrix <- is.na(df_missing_sim)\n\n# 为了防止列名顺序问题，确保只遍历存在的列\ncommon_cols <- intersect(names(df_truth), names(df_imp_rf))\n\nfor (col in common_cols) {\n  # 只评估有缺失值的列\n  if (sum(na_matrix[, col]) > 0) {\n    \n    # 确定变量类型\n    is_num <- is.numeric(df_truth[[col]])\n    type <- if(is_num) \"numeric\" else \"categorical\"\n    \n    # 提取该列的缺失索引\n    idx <- which(na_matrix[, col])\n    \n    # 1. 评估简单填补\n    res_simple <- evaluate_imputation(df_truth[[col]], df_imp_simple[[col]], idx, type)\n    # 2. 评估 PMM\n    res_pmm <- evaluate_imputation(df_truth[[col]], df_imp_pmm[[col]], idx, type)\n    # 3. 评估 RF\n    res_rf <- evaluate_imputation(df_truth[[col]], df_imp_rf[[col]], idx, type)\n    \n    # 存储结果\n    results[[col]] <- data.frame(\n      Variable = col,\n      Type = type,\n      Method = c(\"Mean/Mode\", \"PMM\", \"RandomForest\"),\n      Metric_Value = c(res_simple[1], res_pmm[1], res_rf[1]) \n    )\n  }\n}\n\nfinal_evaluation <- do.call(rbind, results)\nrownames(final_evaluation) <- NULL \nprint(final_evaluation)\n\ntarget_var <- \"duration\" # 替换为你数据中缺失较多的数值变量名\n\n# 构建绘图数据\nplot_df <- rbind(\n  data.frame(val = df_truth[[target_var]], type = \"Original (Truth)\"),\n  data.frame(val = df_imp_simple[[target_var]], type = \"Mean/Mode\"),\n  data.frame(val = df_imp_pmm[[target_var]], type = \"PMM\"),\n  data.frame(val = df_imp_rf[[target_var]], type = \"Random Forest\")\n)\n\n# 绘制密度图\nggplot(plot_df, aes(x = val, color = type, fill = type)) +\n  geom_density(alpha = 0.3) +\n  theme_minimal() +\n  labs(title = paste(\"Imputation Distribution Comparison:\", target_var),\n       subtitle = \"Overlapping with 'Original' indicates better performance\") +\n  scale_color_brewer(palette = \"Set1\") +\n  scale_fill_brewer(palette = \"Set1\")\n```\n## 运行随机森林插补\n\n```{r}\n# 1. 数据准备\ndf_input <- df_clean %>%\n  mutate(across(where(is.character), as.factor)) %>%\n  as.data.frame()\n\n# 2. 正式运行随机森林填补\nprint(\"开始执行随机森林填补，请稍候...\")\nfinal_imputation_result <- missForest(df_input, ntree = 100, verbose = TRUE)\n\n# 3. 提取填补后的数据集\ndf_final <- final_imputation_result$ximp\n\n# 4. 最终检查\nprint(\"填补完成！\")\nprint(paste(\"剩余缺失值数量:\", sum(is.na(df_final)))) # 结果应为 0\n\nwrite.csv(df_final, \"/Users/inori/Desktop/数据分析/银行电话营销策略分析/bank_marketing_imputed.csv\", row.names = FALSE)\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"output-file":"posts:bank-marketing:index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.27","theme":"cosmo","title-block-banner":true,"title":"银行电话营销转化预测","author":"曹颖","date":"2026-01-30","categories":["Machine Learning","R","Visualization"],"image":"image.jpg"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}